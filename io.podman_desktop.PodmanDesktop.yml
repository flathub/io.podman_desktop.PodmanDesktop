app-id: io.podman_desktop.PodmanDesktop
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: "25.08"
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
command: run.sh
separate-locales: false
finish-args:
  - "--socket=x11"
  - "--share=ipc"
  - "--device=dri"
  - "--filesystem=home"
  - "--filesystem=xdg-run/podman:create"
  - "--filesystem=xdg-run/containers:create"
  - "--filesystem=/run/docker.sock"
  - "--share=network"
  - "--talk-name=org.freedesktop.Notifications"
  - "--talk-name=org.kde.StatusNotifierWatcher"
  - "--talk-name=org.freedesktop.Flatpak"
  - "--talk-name=org.freedesktop.secrets"
  - "--talk-name=org.kde.kwalletd6"
  # required to fix cursor scaling on wayland https://github.com/electron/electron/issues/19810 when the user uses --socket=wayland in their flatpak run
  - "--env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons"
  - "--env=XDG_SESSION_TYPE=x11"
modules:
  # fix libsecret under flatpak
  # https://github.com/flathub/org.signal.Signal/pull/756/commits/2caf105b18f906e7707f67b3cf7384a21f461564
  # https://github.com/flathub/com.vscodium.codium/issues/239#issuecomment-1833799015
  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dcrypto=disabled
      - -Dvapi=false
      - -Dgtk_doc=false
      - -Dintrospection=false
      - -Dbash_completion=disabled
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libsecret/0.21/libsecret-0.21.7.tar.xz
        sha256: 6b452e4750590a2b5617adc40026f28d2f4903de15f1250e1d1c40bfd68ed55e
        x-checker-data:
          type: gnome
          name: libsecret
          stable-only: true
  # Podman Desktop sources
  - name: podman-desktop
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node22/bin:/run/build/podman-desktop/bin
      env:
        npm_config_nodedir: /usr/lib/sdk/node22
        XDG_CACHE_HOME: /run/build/podman-desktop/flatpak-node/cache
        DEBUG: electron-rebuild,electron-builder,@electron/get:index
        electron_config_cache: /run/build/podman-desktop/electron-cache
    build-commands:
      - chmod 755 pnpm
      - mkdir bin && mv pnpm bin/
      # Display tooling version
      - node --version
      - pnpm --version
      - sed -i "s#postinstall\":\ \"\(.*\)\"#postinstall\":\ \"\"#g" package.json # remove playwright install step that downloads at runtime files from internet
      - mkdir pnpm-store && mv v10 pnpm-store/
      - echo home is $HOME
      - pnpm install --loglevel debug --offline --frozen-lockfile --store-dir ./pnpm-store
      # Replace segment key
      - sed -i -r -e "s/SEGMENT_KEY = '.*'/SEGMENT_KEY = '$(echo -n 'ODdEZUpwVFhmU05pemF5MUNxQXhsSzViYUQ4VUE1NUQ=' | base64 --decode)'/" packages/main/src/plugin/telemetry/telemetry.ts
      - . ./electron-builder-env.sh; pnpm run build
      - . ./electron-builder-env.sh; ./node_modules/.bin/electron-builder build --config .electron-builder.config.cjs --linux --dir
      - cp -a dist/linux*unpacked /app/main
      - for size in {32,64,128,256,512}; do rsvg-convert -w $size -h $size -f png -o "${FLATPAK_ID}.png" "buildResources/icon.svg"; echo "generating ${FLATPAK_ID} png file for size ${size}"; install -p -Dm644 "${FLATPAK_ID}.png" -t "${FLATPAK_DEST}/share/icons/hicolor/${size}x${size}/apps/"; done;
      # add scalable svg icon
      - install -p -Dm644 "buildResources/icon.svg" "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg";
      # add metainfo
      - install -Dm644 ".flatpak-appdata.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      # add desktop file
      - install -Dm644 .flatpak.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - sed -i -e 's$https://raw.githubusercontent.com/containers/podman-desktop/media/screenshot.png$https://github.com/podman-desktop/podman-desktop/raw/refs/tags/v1.19.1/website/static/img/features/homepage.webp$g' /app/share/applications/${FLATPAK_ID}.desktop
      # Install run script
      - install -Dm755 -t /app/bin/ run.sh
    sources:
      # pnpm tool used to build the project
      - type: file
        url: https://github.com/pnpm/pnpm/releases/download/v10.20.0/pnpm-linux-x64
        dest-filename: pnpm
        sha256: d25defac8655080add042decfa94b5c3b28cafbb048edd4de6dc2c41f9220418
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/pnpm/pnpm/releases/download/v10.20.0/pnpm-linux-arm64
        dest-filename: pnpm
        sha256: 4764bda31f770121b8ff3cd5edfb1ed24afa16046b992fd00028150bf080fbff
        only-arches:
          - aarch64
      # source code of Podman Desktop:  
      - type: archive
        url: https://github.com/containers/podman-desktop/archive/refs/tags/v1.24.2.tar.gz
        sha256: b14e5a46e348996387e6cced27789f10c95a0791c9a1cadb2c60382e9e1ed2fd
      # all dependencies being used for x64 arch  
      - type: archive
        url: https://github.com/containers/podman-desktop/releases/download/v1.24.2/store-cache-pnpm-amd64.tgz
        sha256: 208ab43abd150b1481a8f3556b34dfe003320ccbb46ff17b206f6b3bce8391c1
        only-arches:
          - x86_64
      # all dependencies being used for arm64 arch   
      - type: archive
        url: https://github.com/containers/podman-desktop/releases/download/v1.24.2/store-cache-pnpm-arm64.tgz
        sha256: ffbcf1b170d33e7fe787df3b3eb78dedc29575b3c5e1a921c7c4981b4c66b1f0
        only-arches:
          - aarch64
      # electron used for arm64   
      - type: file
        url: https://github.com/electron/electron/releases/download/v39.2.6/electron-v39.2.6-linux-arm64.zip
        sha256: cdc9850b3b2a35310fe73e1ebaa1351672ed1809ab306e6d872287dbeffeb636
        dest: electron-cache/76c59a96ca2c221300473ecafa31d0a9f14d009b3a9693ed4d86f6be7a4d2b04/
        only-arches:
          - aarch64
      # electron used for x64   
      - type: file
        url: https://github.com/electron/electron/releases/download/v39.2.6/electron-v39.2.6-linux-x64.zip
        sha256: 541037d902d376dc631ffa671f1ed7ea780e9b03e48305ee960ab72ec4d3f5d0
        dest: electron-cache/76c59a96ca2c221300473ecafa31d0a9f14d009b3a9693ed4d86f6be7a4d2b04/
        only-arches:
          - x86_64
          # - generated-sources.json
      - type: script
        dest-filename: run.sh
        commands:
          # Wrapper to launch the app
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - zypak-wrapper.sh /app/main/podman-desktop "$@"
      - type: script
        dest-filename: electron-builder-env.sh
        commands:
          - export MODE=production
          - export ELECTRON_CACHE="$(pwd)/electron-cache/76c59a96ca2c221300473ecafa31d0a9f14d009b3a9693ed4d86f6be7a4d2b04"
          - export ELECTRON_BUILDER_ARCH_ARGS=$(case "$FLATPAK_ARCH" in "i386") echo "--ia32" ;; "x86_64") echo "--x64" ;; "arm") echo "--armv7l" ;; "aarch64") echo "--arm64" ;; esac)
